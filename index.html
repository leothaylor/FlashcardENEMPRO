<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flashcard ENEM - Vers√£o Enxuta</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root {
      --bg0: #070b12;
      --bg1: #0a1220;
      --card: #0c172a;
      --border: rgba(255,255,255,.08);
      --border-glow: rgba(96,165,250,.4);
      --txt: #eaf0ff;
      --muted: rgba(234,240,255,.60);
      --accent: #60a5fa;
      --hard: #ef4444;
      --radius: 18px;
      --shadow: 0 18px 80px rgba(0,0,0,.55);
      --glow: 0 0 20px rgba(96,165,250,.15);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    
    body {
      font-family: 'Inter', sans-serif;
      color: var(--txt);
      background: linear-gradient(180deg, var(--bg0), var(--bg1));
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      overflow-x: hidden;
    }

    .app {
      width: min(800px, 100%);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Topo e Sele√ß√£o */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
    }
    
    .header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    select {
      background: rgba(0,0,0,.3);
      border: 1px solid var(--border);
      color: var(--txt);
      padding: 8px 14px;
      border-radius: 10px;
      font-family: inherit;
      font-weight: 600;
      outline: none;
      cursor: pointer;
    }

    /* Progresso */
    .progress-container {
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
    }

    .stats-row span b { color: var(--txt); }
    .stats-row .hard-count { color: var(--hard); }

    .progress-bar {
      height: 8px;
      background: rgba(0,0,0,.4);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Flashcard Central */
    .flashcard {
      background: var(--card);
      border: 1px solid var(--border-glow);
      border-radius: var(--radius);
      box-shadow: var(--shadow), var(--glow);
      min-height: 400px;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .card-header {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
    }

    .card-body {
      padding: 24px 20px;
      flex: 1;
      overflow-y: auto;
      max-height: 50vh;
      font-size: 16px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .card-body::-webkit-scrollbar { width: 8px; }
    .card-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 4px; }

    .alts {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .alt {
      background: rgba(255,255,255,.02);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 12px;
      display: flex;
      gap: 12px;
    }

    .alt .key {
      font-weight: 800;
      color: var(--accent);
    }

    /* Bot√µes */
    .controls {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      background: rgba(0,0,0,.1);
      border-bottom-left-radius: var(--radius);
      border-bottom-right-radius: var(--radius);
    }

    .btn {
      background: rgba(255,255,255,.05);
      border: 1px solid var(--border);
      color: var(--txt);
      padding: 12px 16px;
      border-radius: 12px;
      font-family: inherit;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.15s ease;
    }

    .btn:hover { background: rgba(255,255,255,.1); }
    .btn:active { transform: translateY(2px); }
    
    .btn.primary { background: rgba(96,165,250,.15); border-color: var(--accent); color: var(--accent); }
    .btn.primary:hover { background: rgba(96,165,250,.25); }

    .btn.hard { border-color: rgba(239,68,68,.4); color: #fca5a5; }
    .btn.hard.active { background: rgba(239,68,68,.2); border-color: var(--hard); }

    .utility-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }

    /* Ocultar elementos */
    .hidden { display: none !important; }

    /* √Årea de Exporta√ß√£o invis√≠vel (para print) */
    #exportCanvasTarget {
      position: absolute;
      top: -9999px;
      left: -9999px;
    }
  </style>
</head>
<body>

  <div class="app">
    
    <div class="header">
      <h1>üß† Flashcard ENEM</h1>
      <select id="deckSelector"></select>
    </div>

    <div class="progress-container">
      <div class="stats-row">
        <span>Progresso: <b id="uiProgress">0 / 0</b></span>
        <span>Revisados: <b id="uiReviewed">0</b></span>
        <span class="hard-count">Dif√≠ceis marcadas: <b id="uiHardCount">0</b></span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="uiProgressBar"></div>
      </div>
    </div>

    <div class="flashcard">
      <div class="card-header">
        <span id="uiCardId">ID: ‚Äî</span>
        <span id="uiCardSide">Frente (Pergunta)</span>
      </div>
      
      <div class="card-body" id="uiCardContent">
        Carregando...
      </div>

      <div class="controls">
        <button class="btn" id="btnPrev">‚¨ÖÔ∏è Anterior</button>
        <button class="btn primary" id="btnFlip">R ‚Äî Mostrar Resposta</button>
        <button class="btn hard" id="btnHard">üî• Dif√≠cil</button>
        <button class="btn" id="btnNext">Pr√≥ximo ‚û°Ô∏è</button>
      </div>
    </div>

    <div class="utility-bar">
      <button class="btn" id="btnShuffle">üîÄ Embaralhar</button>
      <button class="btn" id="btnReviewHards">üî• Revisar Apenas Dif√≠ceis</button>
      <button class="btn" id="btnRestart">üîÑ Reiniciar Sess√£o</button>
      <button class="btn" id="btnExport">‚¨áÔ∏è Exportar Resultado</button>
    </div>

  </div>

  <div id="exportCanvasTarget"></div>

  <script>
    /* =========================================================
       1. BASE DE DADOS HARDCODED (Adicione suas quest√µes aqui)
       ========================================================= */
    const DATABASE = {
      "ENEM 2020 - Humanas": [
        {
          id: "Q01",
          text: "A no√ß√£o de cidadania moderna associa-se ao reconhecimento de direitos civis, pol√≠ticos e sociais, vinculando-se a processos hist√≥ricos de amplia√ß√£o da participa√ß√£o.",
          alts: [
            "Predom√≠nio do poder religioso sobre as institui√ß√µes estatais.",
            "Substitui√ß√£o da lei por decis√µes individuais.",
            "Amplia√ß√£o de direitos e participa√ß√£o na vida p√∫blica.",
            "Supress√£o de conflitos sociais por coer√ß√£o.",
            "Elimina√ß√£o de pol√≠ticas redistributivas."
          ],
          answer: "C",
          comment: "A cidadania moderna √© fundamentada na expans√£o gradual de direitos (civis, depois pol√≠ticos, e sociais) que garantem maior integra√ß√£o e voz do indiv√≠duo na sociedade."
        },
        {
          id: "Q02",
          text: "No contexto da Revolu√ß√£o Industrial, as condi√ß√µes de trabalho nas f√°bricas inglesas do s√©culo XIX caracterizavam-se por:",
          alts: [
            "Jornadas reduzidas e altos sal√°rios.",
            "Prote√ß√£o estatal rigorosa ao trabalhador infantil.",
            "Jornadas exaustivas, insalubridade e explora√ß√£o de mulheres e crian√ßas.",
            "Igualdade salarial entre g√™neros.",
            "Aus√™ncia de acidentes de trabalho devido √† tecnologia avan√ßada."
          ],
          answer: "C",
          comment: "A Primeira Revolu√ß√£o Industrial foi marcada por severa explora√ß√£o laboral, longas jornadas e falta de qualquer legisla√ß√£o trabalhista de prote√ß√£o."
        }
      ],
      "ENEM 2020 - Natureza": [
        {
          id: "Q03",
          text: "A fotoss√≠ntese √© um processo fundamental para a manuten√ß√£o da vida na Terra. Qual g√°s √© consumido e qual √© liberado na fase fotoqu√≠mica?",
          alts: [
            "Consome O2, libera CO2.",
            "Consome CO2, libera O2.",
            "Consome H2O, libera O2.",
            "Consome N2, libera O2.",
            "Consome CO2, libera CH4."
          ],
          answer: "C",
          comment: "Na fase clara (fotoqu√≠mica), ocorre a fot√≥lise da √°gua (H2O), liberando g√°s oxig√™nio (O2) para o ambiente."
        }
      ]
    };

    /* =========================================================
       2. ESTADO DA SESS√ÉO (Zera ao recarregar a p√°gina)
       ========================================================= */
    let currentDeckName = "";
    let deckCards = [];
    let currentIndex = 0;
    let isFlipped = false;
    
    // Conjuntos para rastrear intera√ß√µes na sess√£o
    let reviewedCards = new Set();
    let hardCards = new Set();

    /* =========================================================
       3. ELEMENTOS DA UI
       ========================================================= */
    const els = {
      deckSelector: document.getElementById('deckSelector'),
      uiProgress: document.getElementById('uiProgress'),
      uiReviewed: document.getElementById('uiReviewed'),
      uiHardCount: document.getElementById('uiHardCount'),
      uiProgressBar: document.getElementById('uiProgressBar'),
      uiCardId: document.getElementById('uiCardId'),
      uiCardSide: document.getElementById('uiCardSide'),
      uiCardContent: document.getElementById('uiCardContent'),
      btnPrev: document.getElementById('btnPrev'),
      btnFlip: document.getElementById('btnFlip'),
      btnHard: document.getElementById('btnHard'),
      btnNext: document.getElementById('btnNext'),
      btnShuffle: document.getElementById('btnShuffle'),
      btnReviewHards: document.getElementById('btnReviewHards'),
      btnRestart: document.getElementById('btnRestart'),
      btnExport: document.getElementById('btnExport'),
      exportCanvasTarget: document.getElementById('exportCanvasTarget')
    };

    /* =========================================================
       4. L√ìGICA DE NAVEGA√á√ÉO E RENDERIZA√á√ÉO
       ========================================================= */
    function init() {
      // Popular select de decks
      els.deckSelector.innerHTML = "";
      Object.keys(DATABASE).forEach(deck => {
        const opt = document.createElement('option');
        opt.value = deck;
        opt.textContent = deck;
        els.deckSelector.appendChild(opt);
      });

      // Carregar primeiro deck
      loadDeck(els.deckSelector.value);

      // Event Listeners UI
      els.deckSelector.addEventListener('change', (e) => loadDeck(e.target.value));
      els.btnFlip.addEventListener('click', toggleFlip);
      els.btnPrev.addEventListener('click', () => navigate(-1));
      els.btnNext.addEventListener('click', () => navigate(1));
      els.btnHard.addEventListener('click', toggleHard);
      els.btnShuffle.addEventListener('click', shuffleDeck);
      els.btnRestart.addEventListener('click', () => loadDeck(currentDeckName));
      els.btnReviewHards.addEventListener('click', startHardReview);
      els.btnExport.addEventListener('click', exportResultPNG);

      // Atalhos de teclado
      document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'r') { e.preventDefault(); toggleFlip(); }
        if (e.key === 'ArrowRight') navigate(1);
        if (e.key === 'ArrowLeft') navigate(-1);
      });
    }

    function loadDeck(deckName, customCardsArray = null) {
      currentDeckName = deckName;
      deckCards = customCardsArray ? [...customCardsArray] : [...DATABASE[deckName]];
      
      // Se n√£o for revis√£o de dif√≠ceis, zera a sess√£o
      if (!customCardsArray) {
        reviewedCards.clear();
        hardCards.clear();
      }
      
      currentIndex = 0;
      isFlipped = false;
      renderCard();
    }

    function renderCard() {
      if (deckCards.length === 0) {
        els.uiCardContent.innerHTML = "Nenhum card dispon√≠vel neste modo.";
        els.uiCardId.textContent = "‚Äî";
        updateProgress();
        return;
      }

      const card = deckCards[currentIndex];
      
      // Marcar como revisado ao exibir a frente
      reviewedCards.add(card.id);
      
      els.uiCardId.textContent = `Card: ${card.id}`;
      els.btnHard.classList.toggle('active', hardCards.has(card.id));

      if (!isFlipped) {
        // FRENTE
        els.uiCardSide.textContent = "Frente (Pergunta)";
        els.btnFlip.textContent = "R ‚Äî Mostrar Resposta";
        
        let html = `<div>${card.text.replace(/\n/g, '<br/>')}</div>`;
        if (card.alts && card.alts.length > 0) {
          html += `<div class="alts">`;
          const keys = ["A","B","C","D","E"];
          card.alts.forEach((alt, i) => {
            html += `<div class="alt"><span class="key">${keys[i]})</span><span>${alt}</span></div>`;
          });
          html += `</div>`;
        }
        els.uiCardContent.innerHTML = html;
      } else {
        // VERSO
        els.uiCardSide.textContent = "Verso (Resposta)";
        els.btnFlip.textContent = "R ‚Äî Mostrar Pergunta";
        
        let html = `<div><strong style="color:var(--accent); font-size:18px;">Gabarito: ${card.answer}</strong></div>`;
        if (card.comment) {
          html += `<div style="margin-top:20px;"><strong>Coment√°rio:</strong><br/>${card.comment.replace(/\n/g, '<br/>')}</div>`;
        }
        els.uiCardContent.innerHTML = html;
      }

      updateProgress();
    }

    function navigate(delta) {
      if (deckCards.length === 0) return;
      currentIndex += delta;
      
      // Loop infinito (se passar do √∫ltimo volta pro primeiro e vice-versa)
      if (currentIndex >= deckCards.length) currentIndex = 0;
      if (currentIndex < 0) currentIndex = deckCards.length - 1;
      
      isFlipped = false;
      renderCard();
    }

    function toggleFlip() {
      if (deckCards.length === 0) return;
      isFlipped = !isFlipped;
      renderCard();
    }

    function toggleHard() {
      if (deckCards.length === 0) return;
      const cardId = deckCards[currentIndex].id;
      
      if (hardCards.has(cardId)) {
        hardCards.delete(cardId);
      } else {
        hardCards.add(cardId);
      }
      renderCard(); // Atualiza cor do bot√£o e contadores
    }

    function updateProgress() {
      const total = deckCards.length;
      const current = total > 0 ? currentIndex + 1 : 0;
      const revCount = reviewedCards.size;
      const pct = total > 0 ? (revCount / total) * 100 : 0;

      els.uiProgress.textContent = `${current} / ${total}`;
      els.uiReviewed.textContent = revCount;
      els.uiHardCount.textContent = hardCards.size;
      els.uiProgressBar.style.width = `${pct}%`;
    }

    function shuffleDeck() {
      if (deckCards.length === 0) return;
      // Algoritmo Fisher-Yates
      for (let i = deckCards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deckCards[i], deckCards[j]] = [deckCards[j], deckCards[i]];
      }
      currentIndex = 0;
      isFlipped = false;
      renderCard();
    }

    function startHardReview() {
      if (hardCards.size === 0) {
        alert("Nenhum card marcado como dif√≠cil nesta sess√£o.");
        return;
      }
      // Filtra o banco base do deck atual para pegar apenas os IDs dif√≠ceis
      const hardsArray = DATABASE[currentDeckName].filter(c => hardCards.has(c.id));
      loadDeck(currentDeckName + " (Revis√£o)", hardsArray);
    }

    /* =========================================================
       5. EXPORTA√á√ÉO (SESS√ÉO)
       ========================================================= */
    async function exportResultPNG() {
      if (deckCards.length === 0) return;
      
      const now = new Date();
      const dateStr = now.toLocaleDateString() + " √†s " + now.toLocaleTimeString();

      const box = document.createElement('div');
      box.style.background = '#0c172a';
      box.style.color = '#eaf0ff';
      box.style.padding = '30px';
      box.style.borderRadius = '18px';
      box.style.border = '2px solid rgba(96,165,250,0.5)';
      box.style.fontFamily = 'Inter, sans-serif';
      box.style.width = '600px';

      let hardsList = Array.from(hardCards).join(', ') || 'Nenhum';

      box.innerHTML = `
        <h2 style="margin: 0 0 5px 0; color: #60a5fa;">üß† Resultado da Sess√£o</h2>
        <p style="margin: 0 0 20px 0; opacity: 0.7; font-size: 14px;">${dateStr}</p>
        
        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
          <p style="margin: 5px 0;"><strong>Deck:</strong> ${currentDeckName}</p>
          <p style="margin: 5px 0;"><strong>Total no Deck:</strong> ${deckCards.length}</p>
          <p style="margin: 5px 0;"><strong>Cards Revisados:</strong> ${reviewedCards.size}</p>
          <p style="margin: 5px 0; color: #ef4444;"><strong>Marcados como Dif√≠cil:</strong> ${hardCards.size}</p>
        </div>

        <div>
          <h3 style="margin-bottom: 10px; font-size: 16px;">IDs Dif√≠ceis para revisar futuramente:</h3>
          <p style="background: rgba(239,68,68,0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(239,68,68,0.3); font-family: monospace; font-size: 14px; word-wrap: break-word;">
            ${hardsList}
          </p>
        </div>
      `;

      els.exportCanvasTarget.appendChild(box);

      try {
        els.btnExport.textContent = "Gerando...";
        const canvas = await html2canvas(box, { backgroundColor: null, scale: 2 });
        const dataUrl = canvas.toDataURL("image/png");
        
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = `Sessao_Flashcard_${now.getTime()}.png`;
        a.click();
      } catch (err) {
        console.error("Erro ao gerar imagem:", err);
        alert("Erro ao exportar. Tente novamente.");
      } finally {
        els.exportCanvasTarget.innerHTML = "";
        els.btnExport.textContent = "‚¨áÔ∏è Exportar Resultado";
      }
    }

    // Inicializa√ß√£o
    init();
  </script>
</body>
</html>
