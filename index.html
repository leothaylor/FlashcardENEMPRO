<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flashcard ENEM - Vers√£o Enxuta</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root {
      --bg0: #070b12;
      --bg1: #0a1220;
      --card: #0c172a;
      --border: rgba(255,255,255,.08);
      --border-glow: rgba(96,165,250,.4);
      --txt: #eaf0ff;
      --muted: rgba(234,240,255,.60);
      --accent: #60a5fa;
      --good: #22c55e;
      --bad: #ef4444;
      --hard: #f59e0b;
      --radius: 18px;
      --shadow: 0 18px 80px rgba(0,0,0,.55);
      --glow: 0 0 20px rgba(96,165,250,.15);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    
    body {
      font-family: 'Inter', sans-serif;
      color: var(--txt);
      background: linear-gradient(180deg, var(--bg0), var(--bg1));
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      overflow-x: hidden;
    }

    .app {
      width: min(860px, 100%);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Topo e Sele√ß√£o */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
    }
    
    .header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    select {
      background: rgba(0,0,0,.3);
      border: 1px solid var(--border);
      color: var(--txt);
      padding: 8px 14px;
      border-radius: 10px;
      font-family: inherit;
      font-weight: 600;
      outline: none;
      cursor: pointer;
    }

    /* Progresso e Status */
    .progress-container {
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      flex-wrap: wrap;
      gap: 10px;
    }

    .stats-row span b { color: var(--txt); }
    .stats-row .hard-count { color: var(--hard); }
    .stats-row .good-count { color: var(--good); }
    .stats-row .bad-count { color: var(--bad); }

    .progress-bar {
      height: 8px;
      background: rgba(0,0,0,.4);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Flashcard Central */
    .flashcard {
      background: var(--card);
      border: 1px solid var(--border-glow);
      border-radius: var(--radius);
      box-shadow: var(--shadow), var(--glow);
      min-height: 450px;
      max-height: 75vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .card-header {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
      flex-shrink: 0;
    }

    .card-body {
      padding: 24px 20px;
      flex: 1;
      overflow-y: auto;
      font-size: 15px;
      line-height: 1.6;
    }

    .card-body::-webkit-scrollbar { width: 8px; }
    .card-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 4px; }

    .question-text {
      white-space: pre-wrap;
      margin-bottom: 20px;
    }

    /* Alternativas */
    .alts {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .alt {
      background: rgba(255,255,255,.02);
      border: 1px solid var(--border);
      padding: 12px 16px;
      border-radius: 12px;
      display: flex;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      align-items: flex-start;
    }

    .alt:hover:not(.locked) {
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.2);
    }

    .alt .key {
      font-weight: 800;
      color: var(--muted);
      min-width: 24px;
    }

    /* Estados das Alternativas */
    .alt.selected {
      background: rgba(96,165,250,.15);
      border-color: var(--accent);
    }
    .alt.selected .key { color: var(--accent); }

    .alt.correct {
      background: rgba(34,197,94,.15) !important;
      border-color: var(--good) !important;
    }
    .alt.correct .key { color: var(--good); }

    .alt.wrong {
      background: rgba(239,68,68,.15) !important;
      border-color: var(--bad) !important;
      opacity: 0.7;
    }
    .alt.wrong .key { color: var(--bad); }

    .alt.locked {
      cursor: default;
    }

    .feedback-box {
      margin-top: 24px;
      padding: 16px;
      background: rgba(0,0,0,.2);
      border-radius: 12px;
      border-left: 4px solid var(--accent);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Bot√µes */
    .controls {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      background: rgba(0,0,0,.1);
      border-bottom-left-radius: var(--radius);
      border-bottom-right-radius: var(--radius);
      flex-shrink: 0;
    }

    .btn {
      background: rgba(255,255,255,.05);
      border: 1px solid var(--border);
      color: var(--txt);
      padding: 12px 16px;
      border-radius: 12px;
      font-family: inherit;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.15s ease;
    }

    .btn:hover { background: rgba(255,255,255,.1); }
    .btn:active { transform: translateY(2px); }
    
    .btn.primary { background: rgba(96,165,250,.15); border-color: var(--accent); color: var(--accent); }
    .btn.primary:hover { background: rgba(96,165,250,.25); }

    .btn.hard { border-color: rgba(245,158,11,.4); color: #fbbf24; }
    .btn.hard.active { background: rgba(245,158,11,.2); border-color: var(--hard); }

    .utility-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }

    /* Ocultar elementos */
    .hidden { display: none !important; }

    /* √Årea de Exporta√ß√£o invis√≠vel (para print) */
    #exportCanvasTarget {
      position: absolute;
      top: -9999px;
      left: -9999px;
    }
  </style>
</head>
<body>

  <div class="app">
    
    <div class="header">
      <h1>üß† Flashcard ENEM</h1>
      <select id="deckSelector"></select>
    </div>

    <div class="progress-container">
      <div class="stats-row">
        <span>Progresso: <b id="uiProgress">0 / 0</b></span>
        <span>Revisados: <b id="uiReviewed">0</b></span>
        <span class="good-count">Acertos: <b id="uiHits">0</b></span>
        <span class="bad-count">Erros: <b id="uiMisses">0</b></span>
        <span class="hard-count">üî• Dif√≠ceis: <b id="uiHardCount">0</b></span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="uiProgressBar"></div>
      </div>
    </div>

    <div class="flashcard">
      <div class="card-header">
        <span id="uiCardId">ID: ‚Äî</span>
        <span id="uiCardSide">Frente (Pergunta)</span>
      </div>
      
      <div class="card-body" id="uiCardContent">
        Carregando...
      </div>

      <div class="controls">
        <button class="btn" id="btnPrev">‚¨ÖÔ∏è Anterior</button>
        <button class="btn primary" id="btnFlip">R ‚Äî Mostrar Resposta</button>
        <button class="btn hard" id="btnHard">üî• Dif√≠cil</button>
        <button class="btn" id="btnNext">Pr√≥ximo ‚û°Ô∏è</button>
      </div>
    </div>

    <div class="utility-bar">
      <button class="btn" id="btnShuffle">üîÄ Embaralhar</button>
      <button class="btn" id="btnReviewHards">üî• Revisar Apenas Dif√≠ceis</button>
      <button class="btn" id="btnRestart">üîÑ Reiniciar Sess√£o</button>
      <button class="btn" id="btnExport">‚¨áÔ∏è Exportar Resultado</button>
    </div>

  </div>

  <div id="exportCanvasTarget"></div>

  <script>
    /* =========================================================
       1. BASE DE DADOS HARDCODED 
       ========================================================= */
    const DATABASE = {
      "ENEM 2020 - Ingl√™s": [
        {
          id: "Q01",
          text: "Os recursos usados nesse p√¥ster de divulga√ß√£o de uma campanha levam o leitor a refletir sobre a necessidade de",
          alts: [
            "criticar o tipo de tratamento dado √† mulher.",
            "rever o desempenho da mulher no trabalho.",
            "questionar a sobrecarga de atribui√ß√µes da mulher.",
            "analisar as pesquisas acerca dos direitos da mulher.",
            "censurar a mulher pelo uso de determinadas palavras."
          ],
          answer: "A",
          comment: "A quest√£o analisa o uso de elementos verbais e n√£o verbais para criticar o machismo estrutural e o tratamento dado √†s mulheres na sociedade."
        },
        {
          id: "Q03",
          text: `A Mother in a Refugee Camp\nNo Madonna and Child could touch\nHer tenderness for a son\nShe soon would have to forget...\nThe air was heavy with odors of diarrhea,\nOf unwashed children with washed-out ribs\nAnd dried-up bottoms waddling in labored steps\nBehind blown-empty bellies.\n\nO escritor nigeriano Chinua Achebe traz uma reflex√£o sobre a situa√ß√£o dos refugiados em um cen√°rio p√≥s-guerra civil em seu pa√≠s. Essa reflex√£o √© constru√≠da no poema por meio da representa√ß√£o de uma m√£e, explorando a(s)`,
          alts: [
            "demonstra√ß√£o de orgulho por n√£o precisar pedir doa√ß√µes.",
            "descri√ß√µes art√≠sticas detalhadas de uma obra conhecida.",
            "aceita√ß√£o de um diagn√≥stico de doen√ßa terminal do filho.",
            "consterna√ß√£o ao visitar o t√∫mulo do filho rec√©m-falecido.",
            "impress√µes sensoriais experimentadas no ambiente."
          ],
          answer: "E",
          comment: "O eu l√≠rico constr√≥i o cen√°rio desolador do campo de refugiados focando nas impress√µes sensoriais (como 'odors of diarrhea')."
        },
        {
          id: "Q04",
          text: "A Minor Bird\nI have wished a bird would fly away,\nAnd not sing by my house all day;\nHave clapped my hands at him from the door\nWhen it seemed as if I could bear no more.\nThe fault must partly have been in me.\nThe bird was not to blame for his key.\nAnd of course there must be something wrong\nIn wanting to silence any song.\n\nNo poema de Robert Frost, as palavras ‚Äúfault‚Äù e ‚Äúblame‚Äù revelam por parte do eu l√≠rico uma",
          alts: [
            "culpa por n√£o poder cuidar do p√°ssaro.",
            "atitude errada por querer matar o p√°ssaro.",
            "necessidade de entender o sil√™ncio do p√°ssaro.",
            "sensibiliza√ß√£o com rela√ß√£o √† natureza do p√°ssaro.",
            "irrita√ß√£o quanto √† persist√™ncia do canto do p√°ssaro."
          ],
          answer: "D",
          comment: "Ao usar 'fault' (culpa) e 'blame' (culpa/responsabilidade), o eu l√≠rico percebe que o p√°ssaro est√° apenas seguindo sua natureza, demonstrando sensibiliza√ß√£o."
        }
      ],
      "ENEM 2020 - Espanhol": [
        {
          id: "Q01_ESP",
          text: "Pablo Pueblo\nRegresa un hombre en silencio\nDe su trabajo cansado\nSu paso no lleva prisa\nSu sombra nunca lo alcanza\nLo espera el barrio de siempre\nCon el farol en la esquina\n\nRub√©n Blades es un compositor paname√±o de canciones socialmente comprometidas. El t√≠tulo Pablo Pueblo, asociado al contenido de la letra de la canci√≥n, revela una cr√≠tica social al",
          alts: [
            "contrapor a individualidade de um sujeito a uma estrutura social marcada pela decep√ß√£o na atua√ß√£o pol√≠tica.",
            "demonstrar que o problema sofrido pelo indiv√≠duo atinge toda a comunidade.",
            "relativizar a import√¢ncia que se d√° ao sofrimento individual em uma estrutura social baseada na explora√ß√£o.",
            "descrever a vida de um sujeito que nunca resolve suas inquieta√ß√µes e, por isso, mant√©m-se silencioso.",
            "usar um apelido jocoso para designar a atua√ß√£o de um indiv√≠duo em seu pr√≥prio bairro."
          ],
          answer: "A",
          comment: "A m√∫sica personifica no indiv√≠duo 'Pablo Pueblo' a frustra√ß√£o coletiva do povo frente √†s promessas pol√≠ticas n√£o cumpridas."
        }
      ],
      "ENEM 2020 - Linguagens": [
        {
          id: "Q06",
          text: "Vou-me embora p‚Äôra Pas√°rgada foi o poema de mais longa gesta√ß√£o em toda a minha obra. Vi pela primeira vez esse nome Pas√°rgada quando tinha os meus dezesseis anos e foi num autor grego. [...] Gosto desse poema porque vejo nele, em escor√ßo, toda a minha vida [...].\n\nOs processos de intera√ß√£o comunicativa preveem a presen√ßa ativa de m√∫ltiplos elementos da comunica√ß√£o, entre os quais se destacam as fun√ß√µes da linguagem. Nesse fragmento, a fun√ß√£o da linguagem predominante √© a",
          alts: [
            "emotiva, porque o poeta exp√µe os sentimentos de ang√∫stia que o levaram √† cria√ß√£o po√©tica.",
            "referencial, porque o texto informa sobre a origem do nome empregado em um famoso poema de Bandeira.",
            "metalingu√≠stica, porque o poeta tece coment√°rios sobre a g√™nese e o processo de escrita de um de seus poemas.",
            "po√©tica, porque o texto aborda os elementos est√©ticos de um dos poemas mais conhecidos de Bandeira.",
            "apelativa, porque o poeta tenta convencer os leitores sobre sua dificuldade de compor um poema."
          ],
          answer: "C",
          comment: "A fun√ß√£o metalingu√≠stica ocorre quando o c√≥digo (a linguagem/poema) √© utilizado para explicar o pr√≥prio c√≥digo (o processo de cria√ß√£o do poema)."
        },
        {
          id: "Q08",
          text: "Slam do Corpo √© um encontro pensado para surdos e ouvintes, existente desde 2014, em S√£o Paulo. [...] Nos saraus, o primeiro objetivo foi o de botar os poemas em Libras na roda, colocar os surdos para circular e entender esse encontro entre a poesia e a l√≠ngua de sinais. O que vale √© modular a voz e o corpo, um trabalho artesanal de tornar a palavra ‚Äúvis√≠vel‚Äù.\n\nNa pr√°tica art√≠stica mencionada no texto, o corpo assume papel de destaque ao articular diferentes linguagens com o intuito de",
          alts: [
            "imprimir ritmo e visibilidade √† express√£o po√©tica.",
            "redefinir o espa√ßo de circula√ß√£o da poesia urbana.",
            "estimular produ√ß√µes autorais de usu√°rios de Libras.",
            "traduzir express√µes verbais para a l√≠ngua de sinais.",
            "proporcionar performances est√©ticas de pessoas surdas."
          ],
          answer: "A",
          comment: "O corpo √© utilizado para dar 'visibilidade' e ritmo √† palavra por meio da Libras e da performance corporal integradas."
        }
      ],
      "ENEM 2020 - Humanas": [
        {
          id: "Q46",
          text: "Embora ineg√°veis os benef√≠cios que ambas as economias t√™m auferido do interc√¢mbio comercial, o Brasil tem reiterado seu objetivo de desenvolver com a China uma rela√ß√£o comercial menos assim√©trica. As exporta√ß√µes brasileiras de produtos b√°sicos comp√µem algo entre 75% e 80% da pauta, ao passo que as importa√ß√µes brasileiras consistem em 95% de produtos industrializados chineses.\n\nUma a√ß√£o estatal de longo prazo capaz de reduzir a assimetria na balan√ßa comercial brasileira, conforme exposto no texto, √© o(a)",
          alts: [
            "expans√£o do setor extrativista.",
            "incremento da atividade agr√≠cola.",
            "diversifica√ß√£o da matriz energ√©tica.",
            "fortalecimento da pesquisa cient√≠fica.",
            "monitoramento do fluxo alfandeg√°rio."
          ],
          answer: "D",
          comment: "Para exportar produtos com maior valor agregado (tecnologia/ind√∫stria) e reduzir a depend√™ncia de commodities, o Estado precisa investir em pesquisa e desenvolvimento cient√≠fico."
        },
        {
          id: "Q47",
          text: "As estat√≠sticas mais recentes do Brasil rural revelam um paradoxo: o emprego de natureza agr√≠cola definha em praticamente todo o pa√≠s, mas a popula√ß√£o residente no campo voltou a crescer. Esse novo cen√°rio √© explicado em parte pelo incremento do emprego n√£o agr√≠cola no campo. Ao mesmo tempo, aumentou a massa de desempregados, inativos e aposentados que mant√™m resid√™ncia rural.\n\nSobre o espa√ßo brasileiro, o texto apresenta argumentos que refletem a",
          alts: [
            "heterogeneidade do modo de vida agr√°rio.",
            "redu√ß√£o do fluxo populacional nas cidades.",
            "correla√ß√£o entre for√ßa de trabalho e migra√ß√£o sazonal.",
            "indissociabilidade entre local de moradia e acesso √† renda.",
            "desregulamenta√ß√£o das propriedades nas zonas de fronteira."
          ],
          answer: "A",
          comment: "O campo brasileiro n√£o √© mais exclusivamente voltado para a agropecu√°ria; ele abriga atividades n√£o agr√≠colas, aposentados e desempregados, mostrando grande heterogeneidade."
        }
      ]
    };

    /* =========================================================
       2. ESTADO DA SESS√ÉO 
       ========================================================= */
    let currentDeckName = "";
    let deckCards = [];
    let currentIndex = 0;
    
    // Estados do Card Atual
    let isFlipped = false;
    let selectedAnswer = null; // Guarda a letra da alternativa selecionada (A, B, C...)
    
    // M√©tricas da Sess√£o
    let reviewedCards = new Set();
    let hardCards = new Set();
    let scoredCards = new Set(); // Evita contar acerto/erro duas vezes no mesmo card
    let sessionHits = 0;
    let sessionMisses = 0;

    /* =========================================================
       3. ELEMENTOS DA UI
       ========================================================= */
    const els = {
      deckSelector: document.getElementById('deckSelector'),
      uiProgress: document.getElementById('uiProgress'),
      uiReviewed: document.getElementById('uiReviewed'),
      uiHits: document.getElementById('uiHits'),
      uiMisses: document.getElementById('uiMisses'),
      uiHardCount: document.getElementById('uiHardCount'),
      uiProgressBar: document.getElementById('uiProgressBar'),
      
      uiCardId: document.getElementById('uiCardId'),
      uiCardSide: document.getElementById('uiCardSide'),
      uiCardContent: document.getElementById('uiCardContent'),
      
      btnPrev: document.getElementById('btnPrev'),
      btnFlip: document.getElementById('btnFlip'),
      btnHard: document.getElementById('btnHard'),
      btnNext: document.getElementById('btnNext'),
      btnShuffle: document.getElementById('btnShuffle'),
      btnReviewHards: document.getElementById('btnReviewHards'),
      btnRestart: document.getElementById('btnRestart'),
      btnExport: document.getElementById('btnExport'),
      exportCanvasTarget: document.getElementById('exportCanvasTarget')
    };

    /* =========================================================
       4. L√ìGICA DE NAVEGA√á√ÉO E RENDERIZA√á√ÉO
       ========================================================= */
    function init() {
      els.deckSelector.innerHTML = "";
      Object.keys(DATABASE).forEach(deck => {
        const opt = document.createElement('option');
        opt.value = deck;
        opt.textContent = deck;
        els.deckSelector.appendChild(opt);
      });

      loadDeck(els.deckSelector.value);

      els.deckSelector.addEventListener('change', (e) => loadDeck(e.target.value));
      els.btnFlip.addEventListener('click', toggleFlip);
      els.btnPrev.addEventListener('click', () => navigate(-1));
      els.btnNext.addEventListener('click', () => navigate(1));
      els.btnHard.addEventListener('click', toggleHard);
      els.btnShuffle.addEventListener('click', shuffleDeck);
      els.btnRestart.addEventListener('click', () => loadDeck(currentDeckName));
      els.btnReviewHards.addEventListener('click', startHardReview);
      els.btnExport.addEventListener('click', exportResultPNG);

      document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'r') { e.preventDefault(); toggleFlip(); }
        if (e.key === 'ArrowRight') navigate(1);
        if (e.key === 'ArrowLeft') navigate(-1);
      });
    }

    function loadDeck(deckName, customCardsArray = null) {
      currentDeckName = deckName;
      deckCards = customCardsArray ? [...customCardsArray] : [...DATABASE[deckName]];
      
      if (!customCardsArray) {
        reviewedCards.clear();
        hardCards.clear();
        scoredCards.clear();
        sessionHits = 0;
        sessionMisses = 0;
      }
      
      currentIndex = 0;
      resetCardState();
      renderCard();
    }

    function resetCardState() {
      isFlipped = false;
      selectedAnswer = null;
    }

    // Fun√ß√£o chamada globalmente pelo onclick do HTML gerado
    window.selectAlt = function(letter) {
      if (isFlipped) return; // Bloqueia mudan√ßa se j√° virou a carta
      selectedAnswer = letter;
      renderCard();
    };

    function renderCard() {
      if (deckCards.length === 0) {
        els.uiCardContent.innerHTML = "Nenhum card dispon√≠vel neste modo.";
        els.uiCardId.textContent = "‚Äî";
        updateProgress();
        return;
      }

      const card = deckCards[currentIndex];
      reviewedCards.add(card.id);
      
      els.uiCardId.textContent = `Card: ${card.id}`;
      els.btnHard.classList.toggle('active', hardCards.has(card.id));

      els.uiCardSide.textContent = isFlipped ? "Verso (Resposta)" : "Frente (Pergunta)";
      els.btnFlip.textContent = isFlipped ? "R ‚Äî Ocultar Resposta" : "R ‚Äî Mostrar Resposta";

      // Monta o HTML dinamicamente
      let html = `<div class="question-text">${card.text}</div>`;
      
      if (card.alts && card.alts.length > 0) {
        html += `<div class="alts">`;
        const keys = ["A","B","C","D","E"];
        
        card.alts.forEach((alt, i) => {
          const key = keys[i];
          let classes = "alt";
          let clickAttr = `onclick="selectAlt('${key}')"`;

          if (!isFlipped) {
            if (selectedAnswer === key) classes += " selected";
          } else {
            classes += " locked";
            clickAttr = ""; // Remove a√ß√£o de clique no verso
            
            if (key === card.answer) {
              classes += " correct";
            } else if (selectedAnswer === key) {
              classes += " wrong";
            }
          }

          html += `<div class="${classes}" ${clickAttr}><span class="key">${key})</span><span>${alt}</span></div>`;
        });
        html += `</div>`;
      }

      // Se virado, anexa gabarito e coment√°rio no fim
      if (isFlipped) {
        html += `
          <div class="feedback-box">
            <div style="font-weight: 800; color: var(--accent); margin-bottom: 8px;">Gabarito Correto: ${card.answer}</div>
            ${card.comment ? `<div style="font-size: 14px; color: var(--txt);">${card.comment}</div>` : ''}
          </div>
        `;
      }

      els.uiCardContent.innerHTML = html;
      updateProgress();
    }

    function toggleFlip() {
      if (deckCards.length === 0) return;
      const card = deckCards[currentIndex];

      // Computa acerto/erro na exata hora em que vira o card PELA PRIMEIRA VEZ
      if (!isFlipped && selectedAnswer && !scoredCards.has(card.id)) {
        if (selectedAnswer === card.answer) sessionHits++;
        else sessionMisses++;
        scoredCards.add(card.id);
      }

      isFlipped = !isFlipped;
      renderCard();
    }

    function navigate(delta) {
      if (deckCards.length === 0) return;
      currentIndex += delta;
      
      if (currentIndex >= deckCards.length) currentIndex = 0;
      if (currentIndex < 0) currentIndex = deckCards.length - 1;
      
      resetCardState();
      renderCard();
    }

    function toggleHard() {
      if (deckCards.length === 0) return;
      const cardId = deckCards[currentIndex].id;
      
      if (hardCards.has(cardId)) hardCards.delete(cardId);
      else hardCards.add(cardId);
      
      renderCard();
    }

    function updateProgress() {
      const total = deckCards.length;
      const current = total > 0 ? currentIndex + 1 : 0;
      const revCount = reviewedCards.size;
      const pct = total > 0 ? (revCount / total) * 100 : 0;

      els.uiProgress.textContent = `${current} / ${total}`;
      els.uiReviewed.textContent = revCount;
      els.uiHits.textContent = sessionHits;
      els.uiMisses.textContent = sessionMisses;
      els.uiHardCount.textContent = hardCards.size;
      els.uiProgressBar.style.width = `${pct}%`;
    }

    function shuffleDeck() {
      if (deckCards.length === 0) return;
      for (let i = deckCards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deckCards[i], deckCards[j]] = [deckCards[j], deckCards[i]];
      }
      currentIndex = 0;
      resetCardState();
      renderCard();
    }

    function startHardReview() {
      if (hardCards.size === 0) {
        alert("Nenhum card marcado como dif√≠cil nesta sess√£o.");
        return;
      }
      const hardsArray = DATABASE[currentDeckName].filter(c => hardCards.has(c.id));
      loadDeck(currentDeckName + " (Revis√£o)", hardsArray);
    }

    /* =========================================================
       5. EXPORTA√á√ÉO ESTRUTURADA
       ========================================================= */
    async function exportResultPNG() {
      if (deckCards.length === 0) return;
      
      const now = new Date();
      const dateStr = now.toLocaleDateString() + " √†s " + now.toLocaleTimeString();
      const totalAns = sessionHits + sessionMisses;
      const accuracy = totalAns > 0 ? Math.round((sessionHits / totalAns) * 100) : 0;

      const box = document.createElement('div');
      box.style.background = '#0c172a';
      box.style.color = '#eaf0ff';
      box.style.padding = '32px';
      box.style.borderRadius = '24px';
      box.style.border = '2px solid rgba(96,165,250,0.5)';
      box.style.fontFamily = 'Inter, sans-serif';
      box.style.width = '640px';

      let hardsList = Array.from(hardCards).join(', ') || 'Nenhum';

      box.innerHTML = `
        <h2 style="margin: 0 0 8px 0; color: #60a5fa; font-size: 24px; display: flex; align-items: center; gap: 10px;">
          üß† Resultado da Sess√£o
        </h2>
        <p style="margin: 0 0 24px 0; opacity: 0.7; font-size: 14px;">${dateStr}</p>
        
        <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 16px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.08);">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 16px;">
            <div><strong>Deck:</strong> ${currentDeckName}</div>
            <div><strong>Total no Deck:</strong> ${deckCards.length}</div>
            <div><strong>Cards Revisados:</strong> ${reviewedCards.size}</div>
            <div style="color: #f59e0b;"><strong>Marcados como Dif√≠cil:</strong> ${hardCards.size}</div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 24px;">
            <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); padding: 16px; border-radius: 12px; text-align: center;">
                <div style="font-size: 13px; color: #22c55e; font-weight: 700; text-transform: uppercase;">Acertos</div>
                <div style="font-size: 28px; font-weight: 800; color: #fff;">${sessionHits}</div>
            </div>
            <div style="background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); padding: 16px; border-radius: 12px; text-align: center;">
                <div style="font-size: 13px; color: #ef4444; font-weight: 700; text-transform: uppercase;">Erros</div>
                <div style="font-size: 28px; font-weight: 800; color: #fff;">${sessionMisses}</div>
            </div>
            <div style="background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.3); padding: 16px; border-radius: 12px; text-align: center;">
                <div style="font-size: 13px; color: #60a5fa; font-weight: 700; text-transform: uppercase;">Precis√£o</div>
                <div style="font-size: 28px; font-weight: 800; color: #fff;">${accuracy}%</div>
            </div>
        </div>

        <div>
          <h3 style="margin-bottom: 12px; font-size: 15px; color: rgba(255,255,255,0.8);">IDs Dif√≠ceis para revisar futuramente:</h3>
          <p style="background: rgba(0,0,0,0.3); padding: 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-family: monospace; font-size: 15px; word-wrap: break-word; color: #fca5a5; line-height: 1.5;">
            ${hardsList}
          </p>
        </div>
      `;

      els.exportCanvasTarget.appendChild(box);

      try {
        els.btnExport.textContent = "Gerando...";
        const canvas = await html2canvas(box, { backgroundColor: null, scale: 2 });
        const dataUrl = canvas.toDataURL("image/png");
        
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = `Resultado_Flashcard_${now.getTime()}.png`;
        a.click();
      } catch (err) {
        console.error("Erro ao gerar imagem:", err);
        alert("Erro ao exportar. Tente novamente.");
      } finally {
        els.exportCanvasTarget.innerHTML = "";
        els.btnExport.textContent = "‚¨áÔ∏è Exportar Resultado";
      }
    }

    // Inicializa√ß√£o
    init();
  </script>
</body>
</html>
